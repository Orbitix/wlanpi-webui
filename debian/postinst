#!/bin/bash
# postinst script
#
# see: dh_installdeb(1)

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

# function to check if a given path is a symlink
function isValidSymlink() {
    if [ -L "$1" ]; then
        return 0
    else
        return 1
    fi
}

# get python version, remove spaces, get Python3.7 or Python3.9, lowercase
PYTHONSTUB=`python3 -V 2>&1 | sed 's/ //g' | grep -oP '(\w+\.\d+)' | tr 'P' 'p'`

# the actual target working directory (this is a workaround so we can support multiple Python versions at build)
THE_REAL_DIRECTORY=/opt/wlanpi-webui/lib/$PYTHONSTUB/site-packages/wlanpi_webui

# this is the parent directory which holds our linked working directory
TARGET_PARENT_DIRECTORY=/opt/wlanpi-webui/workingdirectory

# this is the path that we need to check if is already a link
TARGET_PATH=/opt/wlanpi-webui/workingdirectory/wlanpi_webui

# if link doesn't exist, create it
if ! isValidSymlink $TARGET_PATH; then
    ln -s $THE_REAL_DIRECTORY $TARGET_PARENT_DIRECTORY
fi

CONF_CHANGED=1

# if conf is not a symlink, and exists as a file, create backup.
NGINX_CONF=/etc/nginx/nginx.conf
if ! isValidSymlink $NGINX_CONF; then
    if [ -f "$NGINX_CONF" ]; then
        TSTAMP=`date '+%s'`
        NEW_CONF="$NGINX_CONF.$TSTAMP"
        echo "Existing nginx.conf detected; backing it up and moving it to $NEW_CONF..."
        mv $NGINX_CONF $NEW_CONF
    fi
    echo "Linking our nginx.conf config..."
    ln -s /etc/wlanpi-webui/nginx/nginx.conf $NGINX_CONF
    CONF_CHANGED=0
fi

# if default site is enabled, disable it.
DEFAULT_FILE=/etc/nginx/sites-enabled/default
if isValidSymlink $DEFAULT_FILE; then
    echo "Unlinking $DEFAULT_FILE"
    unlink $DEFAULT_FILE
fi

# if wlanpi_librespeed.conf is not a symlink, create symlink.
WLANPI_LIBRESPEED=/etc/nginx/sites-enabled/wlanpi_librespeed.conf
if ! isValidSymlink $WLANPI_LIBRESPEED; then
    echo "Linking wlanpi_librespeed.conf..."
    ln -s /etc/wlanpi-webui/nginx/sites-enabled/wlanpi_librespeed.conf $WLANPI_LIBRESPEED
    CONF_CHANGED=0
fi

# if wlanpi_webui.conf is not a symlink, create symlink.
WLANPI_WEBUI=/etc/nginx/sites-enabled/wlanpi_webui.conf
if ! isValidSymlink $WLANPI_WEBUI; then
    echo "Linking wlanpi_webui.conf..."
    ln -s /etc/wlanpi-webui/nginx/sites-enabled/wlanpi_webui.conf $WLANPI_WEBUI
    CONF_CHANGED=0
fi

# if we changed a nginx config file, test config, and restart nginx.
if [ $CONF_CHANGED -eq 0 ]; then
    # check nginx actually exists first
    if which nginx; then
        nginx -t
        systemctl restart nginx.service
    fi
fi

# generate garbage.dat file
GARBAGE=/var/www/librespeed/librespeed/garbage.dat
GARBAGE_PARENT_DIR=/var/www/librespeed/librespeed
if [ ! -d $GARBAGE_PARENT_DIR ]; then
    mkdir $GARBAGE_PARENT_DIR
fi

if [ ! -f $GARBAGE ]; then
    echo "Creating 10 MB garbage.dat for librespeed..."
    dd if=/dev/urandom of=$GARBAGE bs=10485760 count=1
fi

# fix up permissions
if [ -d /var/www/librespeed ]; then
    chown -R www-data:www-data /var/www/librespeed
fi

exit 0
